version: '3.9'

services:
  frontend:
    build: ./frontend
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
    environment:
      - VITE_API_BASE=http://profile:8080
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - profile

  profile:
    build: ./backend/profile
    environment:
      - PROFILE_LISTEN_ADDR=:8080
      - PROFILE_DB_PATH=/data/profile.db
      - OLLAMA_URL=http://host.docker.internal:11434
      - SEARCH_URL=http://search:8090
    ports:
      - "8080:8080"
    volumes:
      - profile-data:/data
    depends_on:
      - search

  search:
    build: ./backend/search
    environment:
      - SEARCH_LISTEN_ADDR=:8090
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - ES_INDEX_PEOPLE=people
      - ES_INDEX_PROPERTY=properties
      - ID4ME_API_KEY=${ID4ME_API_KEY:-}
    ports:
      - "8090:8090"
    depends_on:
      - elasticsearch

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.15.3
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"
    volumes:
      - es-data:/usr/share/elasticsearch/data

volumes:
  profile-data:
  es-data:

